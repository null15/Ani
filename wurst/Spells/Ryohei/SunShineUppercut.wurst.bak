package SunShineUppercut

init

    sunshineUppercutInit()

function missleMoveSunshineUppercut2()
    let t=GetExpiredTimer()
    let id=GetHandleId(t)
    let l__d=LoadUnitHandle(h,id,0)
    let u=LoadUnitHandle(h,id,7)
    let speed=LoadReal(h,id,1)
    let angle=LoadReal(h,id,2)
    let x=GetUnitX(l__d)
    let y=GetUnitY(l__d)
    let x1=LoadReal(h,id,3)
    let y1=LoadReal(h,id,4)
    let a=Atan2(y1-y,x1-x)+angle
    let dist=LoadReal(h,id,6)
    let mh=LoadReal(h,id,5)
    let rd=SR(x,y,x1,y1)
    let p=GetOwningPlayer(u)
    if rd>30 and IsTerrainPathable(x1,y1,PATHING_TYPE_FLYABILITY)==false 
        SetUnitPosition(l__d,x+speed*Cos(a),y+speed*Sin(a))
        SetUnitFacing(l__d,a*bj_RADTODEG)
        SetUnitFlyHeight(l__d,ParabolaZ(mh,dist,rd),0)
    else
        UnitApplyTimedLife(CreateUnit(p,'e0AX',x1,y1,GetRandomReal(0,359)),1,1)
        UnitApplyTimedLife(CreateUnit(p,'e0AW',x1,y1,GetRandomReal(0,359)),1,0.01)
        UnitApplyTimedLife(CreateUnit(p,'e0B1',x1,y1,GetRandomReal(0,359)),1,0.4)
        UnitApplyTimedLife(CreateUnit(p,'e0B4',x1,y1,GetRandomReal(0,359)),1,0.4)
        UnitApplyTimedLife(CreateUnit(p,'e0AZ',x1,y1,GetRandomReal(0,359)),1,0.4)
        UnitApplyTimedLife(CreateUnit(p,'e0B3',x1,y1,GetRandomReal(0,359)),1,0.4)
        SetUnitFlyHeight(l__d,0,0)
        SetUnitPathing(l__d,true)
        n=CreateUnit(p,'h019',x,y,0)
        UnitAddAbility(n,'A09B')
        SetUnitAbilityLevel(n,'A09B',2)
        UnitApplyTimedLife(n,'BTLF',1)
        IssueTargetOrder(n,"thunderbolt",l__d)
        PauseTimer(t)
        DestroyTimer(t)
        FlushChildHashtable(h,id)

function missleMoveSunshineUppercut (unit l__d,real speed,real angle,real x,real y,real mh,unit u )
    let t=CreateTimer()
    let id=GetHandleId(t)
    SaveUnitHandle(h,id,0,l__d)
    SetUnitPathing(l__d,false)
    SaveReal(h,id,1,speed)
    SaveReal(h,id,2,angle*bj_DEGTORAD)
    SaveReal(h,id,3,x)
    SaveReal(h,id,4,y)
    SaveReal(h,id,5,mh)
    SaveReal(h,id,6,SR(x,y,GetUnitX(l__d),GetUnitY(l__d)))
    SaveUnitHandle(h,id,7,u)
    SaveReal(h,id,7,0)
    TimerStart(t,0.03,true,function missleMoveSunshineUppercut2)

function sunshineUppercutCond() returns boolean
    return GetSpellAbilityId()=='A0HF' and udg_B==true

function sunshineUppercutCast2()
    let t=GetExpiredTimer()
    let id=GetHandleId(t)
    let u=LoadUnitHandle(h,id,0)
    let c=LoadUnitHandle(h,id,1)
    real x=GetUnitX(u)
    real y=GetUnitY(u)
    let x1=GetUnitX(c)
    let y1=GetUnitY(c)
    let a=Atan2(y1-y,x1-x)
    let p=GetOwningPlayer(u)
    if SR(x,y,x1,y1)>50 and GetWidgetLife(c)>0 
        x=x+60*Cos(a)
        y=y+60*Sin(a)
        SetUnitPosition(u,x,y)
        SetUnitFacing(u,a*bj_RADTODEG)
        n=CreateUnit(p,'e01P',x,y,a*bj_RADTODEG)
        UnitApplyTimedLife(n,'B000',0.25)
        SetUnitVertexColor(n,255,255,255,100)
        SetUnitTimeScale(n,2)
        SetUnitAnimation(n,"walk")
        SetUnitAnimation(u,"walk")
    else
        UnitDamageTarget(u,c,I2R(10*GetHeroStr(u,true)),false,false,null,null,null)
        SetUnitAnimation(u,"Attack Five")
        missleMoveSunshineUppercut(c,30,0,x1+900*Cos(a),y1+900*Sin(a),450,u)
        UnitAddAbility(c,'Arav')
        UnitRemoveAbility(c,'Arav')
        PauseTimer(t)
        DestroyTimer(t)
        SetUnitTimeScale(u,1)
        SetUnitPathing(u,true)
        PauseUnit(u,false)
        FlushChildHashtable(h,id)
        SetUnitInvulnerable(u,false)

function sunshineUppercutCast()
    let u=GetTriggerUnit()
    let c=GetSpellTargetUnit()
    let t=CreateTimer()
    let id=GetHandleId(t)
    let x=GetUnitX(u)
    let y=GetUnitY(u)
    SaveUnitHandle(h,id,0,u)
    SetUnitPathing(u,false)
    SetUnitAnimation(u,"walk")
    PauseUnit(u,true)
    SaveReal(h,id,9,Atan2(GetUnitY(c)-y,GetUnitX(c)-x))
    SetUnitTimeScale(u,5)
    SetUnitInvulnerable(u,true)
    SaveUnitHandle(h,id,1,c)
    bj_lastPlayedSound=CreateSound("Sound\\Music\\mp3Music\\RyoheiT2.mp3",false,false,true,12700,12700,"")
    StartSound(bj_lastPlayedSound)
    KillSoundWhenDone(bj_lastPlayedSound)
    TimerStart(t,0.025,true,function sunshineUppercutCast2)

function sunshineUppercutInit()
    let t=CreateTrigger()
    integer i=0
    while true
        TriggerRegisterPlayerUnitEvent(t,Player(i),EVENT_PLAYER_UNIT_SPELL_EFFECT,null)
        i=i+1
        if i == bj_MAX_PLAYER_SLOTS
            break
    TriggerAddAction(t,function sunshineUppercutCast)
    TriggerAddCondition(t,Condition(function missleMoveSunshineUppercut2))
